name: "Tauri Build and Publish"

on:
  push:
    branches:
      - main
    tags:
      - "v*.*.*"
  workflow_dispatch:

jobs:
  collect-version:
    if: github.ref_name == 'main' || github.ref_type == 'tag' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    outputs:
      current_version: ${{ steps.package-version.outputs.version }}
      tag_name: v${{ steps.package-version.outputs.version }}
      draft: "false"
      prerelease: ${{ github.ref_type != 'tag' && 'true' || 'false' }}
      body: |
        See the assets to download this version and install.
      name: ObsidianIRC v${{ steps.package-version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
      - name: Get Node project version
        id: package-version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

  # Linux AppImage build (x64)
  publish-linux-appimage:
    needs: collect-version
    permissions:
      contents: write
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: install dependencies (ubuntu)
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev build-essential curl wget libssl-dev libgtk-3-dev libayatana-appindicator3-dev librsvg2-dev patchelf pkg-config

      - name: setup node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: "npm"

      - name: install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: "./src-tauri -> target"

      - name: install frontend dependencies
        run: npm install

      - name: Build AppImage
        run: npm run tauri build -- --bundles appimage

      - name: Publish
        uses: softprops/action-gh-release@v2
        with:
          draft: ${{ needs.collect-version.outputs.draft == 'true' }}
          prerelease: ${{ needs.collect-version.outputs.prerelease == 'true' }}
          body: ${{ needs.collect-version.outputs.body }}
          name: ${{ needs.collect-version.outputs.name }}
          tag_name: ${{ needs.collect-version.outputs.tag_name }}
          generate_release_notes: true
          make_latest: true
          files: |
            ./src-tauri/target/release/bundle/appimage/ObsidianIRC_${{ needs.collect-version.outputs.current_version}}_amd64.AppImage

  # Windows x64 build
  publish-windows:
    needs: collect-version
    permissions:
      contents: write
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: setup node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: "npm"

      - name: install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: "./src-tauri -> target"

      - name: install frontend dependencies
        run: npm install

      - uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ needs.collect-version.outputs.tag_name }}
          releaseName: ${{ needs.collect-version.outputs.name }}
          releaseBody: ${{ needs.collect-version.outputs.body }}
          releaseDraft: ${{ needs.collect-version.outputs.draft == 'true' }}
          prerelease: ${{ needs.collect-version.outputs.prerelease == 'true' }}
          args: ""

  # Android APK build (debug, no signing required)
  publish-android:
    runs-on: ubuntu-latest
    needs: collect-version
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: "22"
          cache: "gradle"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install NDK
        run: sdkmanager "ndk;27.0.11902837"

      - name: setup node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: "npm"

      - name: install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android,armv7-linux-androideabi,i686-linux-android,x86_64-linux-android

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: "./src-tauri -> target"
          shared-key: "android-builds"

      - name: Install dependencies
        run: npm install

      - name: Build Android APK (debug)
        run: npm run tauri android build -- --apk --debug
        env:
          NDK_HOME: ${{ env.ANDROID_HOME }}/ndk/27.0.11902837
          ANDROID_NDK_ROOT: ${{ env.ANDROID_HOME }}/ndk/27.0.11902837
          ANDROID_NDK: ${{ env.ANDROID_HOME }}/ndk/27.0.11902837

      - name: Rename APK file
        run: |
          mv ./src-tauri/gen/android/app/build/outputs/apk/universal/debug/app-universal-debug.apk ./src-tauri/gen/android/app/build/outputs/apk/universal/debug/ObsidianIRC-${{ needs.collect-version.outputs.current_version}}-debug.apk

      - name: Publish
        uses: softprops/action-gh-release@v2
        with:
          draft: ${{ needs.collect-version.outputs.draft == 'true' }}
          prerelease: ${{ needs.collect-version.outputs.prerelease == 'true' }}
          body: ${{ needs.collect-version.outputs.body }}
          name: ${{ needs.collect-version.outputs.name }}
          tag_name: ${{ needs.collect-version.outputs.tag_name }}
          generate_release_notes: true
          make_latest: true
          files: |
            ./src-tauri/gen/android/app/build/outputs/apk/universal/debug/ObsidianIRC-${{ needs.collect-version.outputs.current_version}}-debug.apk
