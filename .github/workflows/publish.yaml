name: "Tauri Build and Publish"

on:
  push:
    branches:
      - main
    tags:
      - "v*.*.*"
  workflow_dispatch:

jobs:
  collect-version:
    if: github.ref_name == 'main' || github.ref_type == 'tag' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    outputs:
      current_version: ${{ steps.package-version.outputs.version }}
      tag_name: ${{ steps.package-version.outputs.tag_name }}
      artifact_version: ${{ steps.package-version.outputs.artifact_version }}
      draft: "false"
      prerelease: ${{ github.ref_type != 'tag' && 'true' || 'false' }}
      body: |
        See the assets to download this version and install.
      name: ObsidianIRC ${{ steps.package-version.outputs.tag_name }}
    steps:
      - uses: actions/checkout@v4
      - name: Get Node project version
        id: package-version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            TAG_NAME="v${VERSION}"
            ARTIFACT_VERSION="${VERSION}"
          else
            # Use unique tag for prereleases to avoid conflicts
            TAG_NAME="v${VERSION}-build${{ github.run_number }}"
            # Artifacts use build number suffix to avoid overwriting
            ARTIFACT_VERSION="${VERSION}-build${{ github.run_number }}"
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "tag_name=$TAG_NAME" >> "$GITHUB_OUTPUT"
          echo "artifact_version=$ARTIFACT_VERSION" >> "$GITHUB_OUTPUT"

  publish-linux-appimage:
    runs-on: ubuntu-22.04
    needs: collect-version
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev build-essential curl wget libssl-dev libgtk-3-dev libayatana-appindicator3-dev librsvg2-dev patchelf pkg-config

      - name: setup node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: "npm"

      - name: install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: "./src-tauri -> target"

      - name: install frontend dependencies
        run: npm install

      - name: Build AppImage
        run: npm run tauri build
        env:
          VITE_DEFAULT_IRC_SERVER: "wss://www.ilex-forest.com/webirc"
          VITE_DEFAULT_IRC_SERVER_NAME: "Ilex Forest"
          VITE_DEFAULT_IRC_CHANNELS: "#ilex-forest"
          VITE_HIDE_SERVER_LIST: "false"
          VITE_GIPHY_API_KEY: ${{ secrets.VITE_GIPHY_API_KEY }}
          OBSIDIANIRC_BUILD_TAG: ${{ needs.collect-version.outputs.tag_name }}

      - name: Rename AppImage
        run: |
          mv ./src-tauri/target/release/bundle/appimage/ObsidianIRC_*.AppImage ./src-tauri/target/release/bundle/appimage/ObsidianIRC_${{ needs.collect-version.outputs.artifact_version }}_amd64.AppImage

      - name: Publish
        uses: softprops/action-gh-release@v2
        with:
          draft: ${{ needs.collect-version.outputs.draft == 'true' }}
          prerelease: ${{ needs.collect-version.outputs.prerelease == 'true' }}
          body: ${{ needs.collect-version.outputs.body }}
          name: ${{ needs.collect-version.outputs.name }}
          tag_name: ${{ needs.collect-version.outputs.tag_name }}
          generate_release_notes: true
          make_latest: true
          files: |
            ./src-tauri/target/release/bundle/appimage/ObsidianIRC_${{ needs.collect-version.outputs.artifact_version }}_amd64.AppImage

  publish-windows:
    runs-on: windows-latest
    needs: collect-version
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: setup node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: "npm"

      - name: install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: "./src-tauri -> target"

      - name: install frontend dependencies
        run: npm install

      - name: Build Windows
        run: npm run tauri build
        env:
          VITE_DEFAULT_IRC_SERVER: "wss://www.ilex-forest.com/webirc"
          VITE_DEFAULT_IRC_SERVER_NAME: "Ilex Forest"
          VITE_DEFAULT_IRC_CHANNELS: "#ilex-forest"
          VITE_HIDE_SERVER_LIST: "false"
          VITE_GIPHY_API_KEY: ${{ secrets.VITE_GIPHY_API_KEY }}
          OBSIDIANIRC_BUILD_TAG: ${{ needs.collect-version.outputs.tag_name }}

      - name: Rename Windows installer
        run: |
          mv ./src-tauri/target/release/bundle/nsis/ObsidianIRC_*_x64-setup.exe ./src-tauri/target/release/bundle/nsis/ObsidianIRC_${{ needs.collect-version.outputs.artifact_version }}_x64-setup.exe

      - name: Publish
        uses: softprops/action-gh-release@v2
        with:
          draft: ${{ needs.collect-version.outputs.draft == 'true' }}
          prerelease: ${{ needs.collect-version.outputs.prerelease == 'true' }}
          body: ${{ needs.collect-version.outputs.body }}
          name: ${{ needs.collect-version.outputs.name }}
          tag_name: ${{ needs.collect-version.outputs.tag_name }}
          generate_release_notes: true
          make_latest: true
          files: |
            ./src-tauri/target/release/bundle/nsis/ObsidianIRC_${{ needs.collect-version.outputs.artifact_version }}_x64-setup.exe

  publish-android:
    runs-on: ubuntu-latest
    needs: collect-version
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: "22"
          cache: "gradle"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install NDK
        run: sdkmanager "ndk;27.0.11902837"

      - name: setup node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: "npm"

      - name: install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android,armv7-linux-androideabi,i686-linux-android,x86_64-linux-android

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: "./src-tauri -> target"
          shared-key: "android-builds"

      - name: Install dependencies
        run: npm install

      - name: Decode keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE }}" | base64 -d > src-tauri/gen/android/obsidianirc.keystore

      - name: Build Android APK (release)
        run: |
          # Configure signing via gradle.properties (in android directory)
          # Use printf with newlines to ensure each property is on a separate line
          printf '\nandroid.signing.key.store=obsidianirc.keystore\n' >> src-tauri/gen/android/gradle.properties
          printf 'android.signing.key.alias=obsidianirc\n' >> src-tauri/gen/android/gradle.properties
          printf 'android.signing.key.storePassword=%s\n' "${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" >> src-tauri/gen/android/gradle.properties
          printf 'android.signing.key.aliasPassword=%s\n' "${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" >> src-tauri/gen/android/gradle.properties
          npm run tauri android build -- --target aarch64 armv7 --apk true
        env:
          NDK_HOME: ${{ env.ANDROID_HOME }}/ndk/27.0.11902837
          ANDROID_NDK_ROOT: ${{ env.ANDROID_HOME }}/ndk/27.0.11902837
          ANDROID_NDK: ${{ env.ANDROID_HOME }}/ndk/27.0.11902837
          VITE_DEFAULT_IRC_SERVER: "wss://www.ilex-forest.com/webirc"
          VITE_DEFAULT_IRC_SERVER_NAME: "Ilex Forest"
          VITE_DEFAULT_IRC_CHANNELS: "#ilex-forest"
          VITE_HIDE_SERVER_LIST: "false"
          VITE_GIPHY_API_KEY: ${{ secrets.VITE_GIPHY_API_KEY }}
          OBSIDIANIRC_BUILD_TAG: ${{ needs.collect-version.outputs.tag_name }}

      - name: Rename APK file
        run: |
          mv src-tauri/gen/android/app/build/outputs/apk/universal/release/app-universal-release.apk \
             src-tauri/gen/android/app/build/outputs/apk/universal/release/ObsidianIRC-${{ needs.collect-version.outputs.artifact_version }}-release.apk

      - name: Publish
        uses: softprops/action-gh-release@v2
        with:
          draft: ${{ needs.collect-version.outputs.draft == 'true' }}
          prerelease: ${{ needs.collect-version.outputs.prerelease == 'true' }}
          body: ${{ needs.collect-version.outputs.body }}
          name: ${{ needs.collect-version.outputs.name }}
          tag_name: ${{ needs.collect-version.outputs.tag_name }}
          generate_release_notes: true
          make_latest: true
          files: |
            src-tauri/gen/android/app/build/outputs/apk/universal/release/ObsidianIRC-${{ needs.collect-version.outputs.artifact_version }}-release.apk
